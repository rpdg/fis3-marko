"use strict";
const fs = require("fs");
const path = require("path");
const marko = require("marko");
const util_1 = require("./util");
let isInited = false;
let needClean = false;
const deletedFileName = '/.deleted';
function initEngine(options) {
    fis.on('release:end', function () {
        let opt = fis.config.data.options;
        let dest;
        if (needClean && (dest = opt.d || opt.dest)) {
            fis.log.info('clean files...');
            setTimeout(function () {
                fs.unlink(path.join(process.cwd(), dest + deletedFileName), function (err) {
                    if (err)
                        fis.log.warn(err);
                    fis.log.info('clean success...');
                });
            }, 1000);
        }
        needClean = false;
    });
}
module.exports = function (content, file, options) {
    if (!content)
        return '';
    if (!file.isHtmlLike)
        return content;
    if (!isInited) {
        util_1.readGlobalData(options.define);
        delete options.define;
        initEngine(options);
        isInited = true;
    }
    let data = util_1.readConfig(file);
    if (data['$release'] === false) {
        needClean = true;
        file.release = deletedFileName;
        return '';
    }
    if (data['$noParse'] === true) {
        return content;
    }
    data = util_1.mergeGlobalData(file.subpath, data);
    data['$file'] = file;
    data['$media'] = fis.project.currentMedia();
    let template = marko.load(file.fullname, {
        writeToDisk: false
    });
    let str = template.renderToString(data);
    return str;
};
//# sourceMappingURL=index.js.map